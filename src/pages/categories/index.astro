---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allCategories = await getCollection('categories');
const posts = await getCollection('posts', ({ data }) => data.draft !== true);

// 统计每个分类的文章数
const categoryCount = posts.reduce((acc, post) => {
	const categoryId = post.data.category.id;
	acc[categoryId] = (acc[categoryId] || 0) + 1;
	return acc;
}, {} as Record<string, number>);

// 合并分类信息和文章数量，按数量排序
const categories = allCategories
	.map(cat => ({
		slug: cat.id,
		name: cat.data.name,
		count: categoryCount[cat.id] || 0,
	}))
	.filter(cat => cat.count > 0)
	.sort((a, b) => b.count - a.count);
---

<BaseLayout title="分类" description="按分类浏览文章">
	<header class="page-header">
		<h1>分类</h1>
		<p class="page-desc">按分类浏览文章</p>
	</header>
	<ul class="category-list">
		{categories.map((category) => (
			<li>
				<a href={`/categories/${category.slug}/page/1`}>
					<span class="name">{category.name}</span>
					<span class="count">{category.count}</span>
				</a>
			</li>
		))}
	</ul>
</BaseLayout>

<style>
	.page-header {
		margin-bottom: 2em;
	}

	.page-header h1 {
		font-size: 1.75em;
		margin: 0 0 0.25em 0;
	}

	.page-desc {
		color: rgb(var(--gray));
		margin: 0;
	}

	.category-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.category-list li {
		margin: 0;
	}

	.category-list a {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1em 0;
		border-bottom: 1px solid rgb(var(--gray-light));
		text-decoration: none;
		color: rgb(var(--gray-dark));
		transition: color 0.2s;
	}

	.category-list a:hover {
		color: var(--accent);
	}

	.name {
		font-size: 1.1em;
	}

	.count {
		background: rgb(var(--gray-light));
		padding: 0.25em 0.75em;
		border-radius: 1em;
		font-size: 0.9em;
		color: rgb(var(--gray));
	}
</style>

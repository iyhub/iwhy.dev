---
import { getCollection, render } from 'astro:content';
import PostLayout from '../../layouts/PostLayout.astro';

export async function getStaticPaths() {
	const posts = (await getCollection('posts', ({ data }) => data.draft !== true))
		.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

	return posts.map((post, index) => {
		const currentTags = post.data.tags || [];

		// 按共同标签数量排序的相关文章（排除当前文章，最多3篇）
		const relatedPosts = posts
			.filter(p => p.id !== post.id)
			.map(p => {
				const pTags = p.data.tags || [];
				const commonTags = currentTags.filter(tag => pTags.includes(tag));
				return { post: p, commonCount: commonTags.length };
			})
			.filter(item => item.commonCount > 0)
			.sort((a, b) => b.commonCount - a.commonCount)
			.slice(0, 3)
			.map(item => item.post);

		return {
			params: { slug: post.id },
			props: {
				post,
				prevPost: posts[index + 1] || null,
				nextPost: posts[index - 1] || null,
				relatedPosts,
			},
		};
	});
}

const { post, prevPost, nextPost, relatedPosts } = Astro.props;
const { Content, headings } = await render(post);
---

<PostLayout post={post} headings={headings} prevPost={prevPost} nextPost={nextPost} relatedPosts={relatedPosts}>
	<Content />
</PostLayout>
